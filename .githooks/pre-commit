#!/bin/bash
# Pre-commit hook for X-Panel
# æäº¤å‰è‡ªåŠ¨æ£€æŸ¥ Go ä»£ç è´¨é‡

set -e

echo "ğŸ” Running pre-commit checks..."

# è·å–æš‚å­˜çš„ Go æ–‡ä»¶
STAGED_GO_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$' || true)

if [ -z "$STAGED_GO_FILES" ]; then
    echo "âœ… No Go files staged, skipping checks."
    exit 0
fi

# 1. gofmt æ£€æŸ¥
echo "ğŸ“ Checking gofmt..."
UNFORMATTED=$(gofmt -l $STAGED_GO_FILES 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo "âŒ The following files need formatting:"
    echo "$UNFORMATTED"
    echo ""
    echo "Run: gofmt -w <file>"
    exit 1
fi
echo "   âœ“ gofmt passed"

# 2. go vet æ£€æŸ¥
echo "ğŸ”¬ Running go vet..."
if ! go vet ./... 2>/dev/null; then
    echo "âŒ go vet failed"
    exit 1
fi
echo "   âœ“ go vet passed"

# 3. golangci-lint å¿«é€Ÿæ£€æŸ¥ (ä»… staged æ–‡ä»¶)
if command -v golangci-lint &> /dev/null; then
    echo "ğŸ§¹ Running golangci-lint..."
    if ! golangci-lint run --new-from-rev=HEAD~1 --timeout=2m 2>/dev/null; then
        echo "âš ï¸  golangci-lint found issues (non-blocking)"
        # ä¸é˜»æ­¢æäº¤ï¼Œåªæ˜¯è­¦å‘Š
    else
        echo "   âœ“ golangci-lint passed"
    fi
else
    echo "âš ï¸  golangci-lint not installed, skipping..."
fi

echo ""
echo "âœ… All pre-commit checks passed!"
exit 0
