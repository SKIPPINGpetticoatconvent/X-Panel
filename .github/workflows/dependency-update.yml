name: Dependency Update Check

on:
  workflow_dispatch:
  schedule:
    # æ¯å¤©æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–° (UTCæ—¶é—´ 0ç‚¹)
    - cron: '0 0 * * *'
  # å»ºè®®ï¼šç§»é™¤åœ¨æ­¤å¤„å¤„ç† pull_requestï¼Œé¿å…é€»è¾‘æ­»å¾ªç¯ã€‚
  # å¦‚æœè¦åœ¨ PR ä¸­æ£€æŸ¥ tidyï¼Œå»ºè®®å•ç‹¬å†™ä¸€ä¸ª CI job ç”¨ git diff --exit-code

jobs:
  update-deps:
    name: Update Dependencies
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4  # ä¿®æ­£: v5 -> v4

      - name: Setup Go
        uses: actions/setup-go@v5  # ä¿®æ­£: v6 -> v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Update Dependencies
        id: update
        run: |
          # 1. å‡çº§æ‰€æœ‰ä¾èµ– (åŒ…æ‹¬æµ‹è¯•ä¾èµ–)
          go get -u -t ./...
          # 2. æ•´ç† go.mod å’Œ go.sum
          go mod tidy
          
          # 3. æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŒ–
          if git diff --quiet go.mod go.sum; then
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… No dependency updates needed"
          else
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "ğŸš€ Dependencies updated"
          fi

      - name: Run tests with updated dependencies
        if: steps.update.outputs.has-updates == 'true'
        run: |
          go test ./... -v

      - name: Create Pull Request
        if: steps.update.outputs.has-updates == 'true'
        uses: peter-evans/create-pull-request@v6 # å»ºè®®ä½¿ç”¨ç¨³å®šç‰ˆ v6 æˆ– v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update Go dependencies
            
            - Ran `go get -u -t ./...`
            - Ran `go mod tidy`
            - Verified tests pass
          title: "chore: update Go dependencies"
          body: |
            This PR updates Go dependencies to their latest minor/patch versions.
            
            ## Changes
            - Updated dependencies in `go.mod` and `go.sum`
            - Ran `go mod tidy`
            - Verified all tests pass
            
            ## Automated
            This PR is auto-generated by the [Dependency Update Check] workflow.
          branch: deps/go-updates
          delete-branch: true
          labels: |
            dependencies
            automated

  vulnerability-check:
    name: Security Vulnerability Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4 # ä¿®æ­£: v5 -> v4

      - name: Setup Go
        uses: actions/setup-go@v5 # ä¿®æ­£: v6 -> v5
        with:
          go-version-file: go.mod
          check-latest: true

      - name: Run Govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          # ç¡®ä¿å°† GOBIN æ·»åŠ åˆ° PATHï¼Œæˆ–è€…ç›´æ¥è¿è¡Œå®‰è£…çš„äºŒè¿›åˆ¶æ–‡ä»¶
          $(go env GOPATH)/bin/govulncheck -format sarif ./... > govulncheck-report.sarif

      - name: Upload SARIF file
        if: always() # å³ä½¿å‘ç°æ¼æ´å¯¼è‡´ä¸Šé¢æ­¥éª¤å¤±è´¥ï¼Œä¹Ÿè¦ä¸Šä¼ æŠ¥å‘Š
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: govulncheck-report.sarif
          category: govulncheck