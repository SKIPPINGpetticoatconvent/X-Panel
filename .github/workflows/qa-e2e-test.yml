name: QA E2E Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'Specific test scenario to run (optional)'
        required: false
        default: 'all'
      debug_mode:
        description: 'Enable debug mode'
        required: false
        default: 'false'

env:
  GO_VERSION: '1.21'
  DOCKER_BUILDKIT: 1

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/go/pkg/mod
          ~/.cache/go-build
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Download Go dependencies
      run: |
        go mod download
        go mod tidy

    - name: Build X-Panel binary
      run: |
        go build -o bin/x-ui main.go

    - name: Set up test environment
      run: |
        # Create test directories
        sudo mkdir -p /tmp/x-panel-e2e/db
        sudo mkdir -p /tmp/x-panel-e2e/logs
        sudo chmod -R 755 /tmp/x-panel-e2e

        # Set environment variables
        echo "GO_ENV=test" >> $GITHUB_ENV
        echo "XUI_DB_FOLDER=/tmp/x-panel-e2e/db" >> $GITHUB_ENV
        echo "XUI_LOG_FOLDER=/tmp/x-panel-e2e/logs" >> $GITHUB_ENV
        echo "XUI_LOG_LEVEL=debug" >> $GITHUB_ENV
        echo "XUI_DEBUG=true" >> $GITHUB_ENV
        echo "XUI_BIN_FOLDER=bin" >> $GITHUB_ENV
        echo "XUI_SNI_FOLDER=bin/sni" >> $GITHUB_ENV
        echo "XPANEL_RUN_IN_CONTAINER=true" >> $GITHUB_ENV
        echo "XUI_ENABLE_FAIL2BAN=false" >> $GITHUB_ENV
        echo "XUI_TEST_PORT=13688" >> $GITHUB_ENV
        echo "XUI_TEST_USERNAME=e2e_admin" >> $GITHUB_ENV
        echo "XUI_TEST_PASSWORD=e2e_test_pass_123" >> $GITHUB_ENV

        # Enable debug mode if requested
        if [[ "${{ github.event.inputs.debug_mode }}" == "true" || "${{ vars.E2E_DEBUG_MODE }}" == "true" ]]; then
          echo "XUI_LOG_LEVEL=debug" >> $GITHUB_ENV
          echo "XUI_DEBUG=true" >> $GITHUB_ENV
        fi

    - name: Run E2E Tests
      run: |
        # Set test timeout based on workflow trigger
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          TEST_TIMEOUT="20m"
        else
          TEST_TIMEOUT="30m"
        fi

        # Determine test pattern
        TEST_PATTERN=""
        if [[ "${{ github.event.inputs.test_scenario }}" != "" && "${{ github.event.inputs.test_scenario }}" != "all" ]]; then
          TEST_PATTERN="-run ${{ github.event.inputs.test_scenario }}"
        fi

        # Run tests with coverage
        go test -v -timeout $TEST_TIMEOUT \
          -coverprofile=coverage-e2e.out \
          -covermode=atomic \
          ./tests/e2e/scenarios/... \
          $TEST_PATTERN

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-test-results-${{ github.run_number }}
        path: |
          coverage-e2e.out
          /tmp/x-panel-e2e/logs/*.log
        retention-days: 7

    - name: Generate test report
      if: always()
      run: |
        # Determine timeout for reporting
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          REPORT_TIMEOUT="20m"
        else
          REPORT_TIMEOUT="30m"
        fi

        echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Go Version**: ${{ env.GO_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Timeout**: $REPORT_TIMEOUT" >> $GITHUB_STEP_SUMMARY
        echo "- **Docker BuildKit**: Enabled" >> $GITHUB_STEP_SUMMARY

        if [[ -f coverage-e2e.out ]]; then
          COVERAGE=$(go tool cover -func=coverage-e2e.out | grep total | awk '{print $3}')
          echo "- **Coverage**: $COVERAGE" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Test Logs" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        if [[ -d /tmp/x-panel-e2e/logs ]]; then
          find /tmp/x-panel-e2e/logs -name "*.log" -exec tail -50 {} \; 2>/dev/null || echo "No log files found"
        else
          echo "No logs directory found"
        fi
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  cleanup:
    name: Cleanup Resources
    runs-on: ubuntu-latest
    if: always()
    needs: e2e-tests

    steps:
    - name: Clean up test environment
      run: |
        # Remove test directories
        sudo rm -rf /tmp/x-panel-e2e

        # Clean up Docker resources
        docker system prune -f --volumes

        echo "Cleanup completed"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/main'
    needs: [e2e-tests, cleanup]

    steps:
    - name: Create failure issue
      uses: actions/github-script@v7
      with:
        script: |
          const title = `E2E Tests Failed - ${process.env.GITHUB_RUN_NUMBER}`;
          const body = `
          ## E2E Test Failure

          **Workflow Run**: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}

          **Branch**: ${process.env.GITHUB_REF_NAME}
          **Commit**: ${process.env.GITHUB_SHA}

          **Triggered by**: ${process.env.GITHUB_ACTOR}

          ### Possible Causes
          - Container startup issues
          - Network connectivity problems
          - Database migration failures
          - API changes breaking tests

          ### Next Steps
          1. Check the test logs in the workflow artifacts
          2. Reproduce the issue locally
          3. Fix the failing tests or underlying issues
          4. Re-run the workflow

          /cc @${process.env.GITHUB_ACTOR}
          `;

          await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: title,
            body: body,
            labels: ['bug', 'e2e-tests', 'automated']
          });