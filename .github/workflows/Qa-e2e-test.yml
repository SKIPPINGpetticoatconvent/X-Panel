name: QA E2E Tests

permissions:
  contents: read

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_ENV: test
  XUI_DB_FOLDER: /tmp/x-panel-e2e/db
  XUI_LOG_FOLDER: /tmp/x-panel-e2e/logs
  XUI_LOG_LEVEL: debug
  XUI_DEBUG: true
  XUI_ENABLE_FAIL2BAN: false
  XUI_TEST_PORT: 13688
  XUI_TEST_USERNAME: e2e_admin
  XUI_TEST_PASSWORD: e2e_test_pass_123
  XPANEL_RUN_IN_CONTAINER: true
  TEST_CONTAINER_RUNTIME: docker

jobs:
  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache: true

      - name: Setup E2E Test Environment
        run: |
          mkdir -p $XUI_DB_FOLDER
          mkdir -p $XUI_LOG_FOLDER

      - name: Download dependencies
        run: go mod download

      - name: Install Testcontainers
        run: |
          go get github.com/testcontainers/testcontainers-go@latest
          go mod tidy

      - name: Run E2E tests
        run: |
          go test -v -timeout 20m ./tests/e2e/...

      - name: Cleanup Test Environment
        if: always()
        run: rm -rf /tmp/x-panel-e2e/