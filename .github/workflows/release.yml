name: Release X-Panel

on:
  workflow_dispatch:
  release:
    types: [published]
  push:
    branches:
      - main
    paths:
      - "config/version"

jobs:
  # ===============================================================
  # 发布前 QA 检查 - 并行执行
  # ===============================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v7
        with:
          version: latest
          args: --timeout=10m

  nilaway:
    name: NilAway
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Cache NilAway
        id: cache-nilaway
        uses: actions/cache@v4
        with:
          path: ~/go/bin/nilaway
          key: nilaway-${{ runner.os }}-latest

      - name: Install NilAway
        if: steps.cache-nilaway.outputs.cache-hit != 'true'
        run: go install go.uber.org/nilaway/cmd/nilaway@latest

      - name: Run NilAway (Deep Static Analysis)
        run: nilaway -test=false ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Install Dependencies
        run: go mod download

      - name: Run Tests
        run: go test -short ./...

      - name: Build Verification
        run: go build ./...

  e2e-build:
    name: E2E Build
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Build binary and create tarball
        run: |
          VERSION=$(tr -d '\n' < config/version)
          GOOS=linux GOARCH=amd64 go build -ldflags "-s -w -X 'github.com/SKIPPINGpetticoatconvent/X-Panel/config.version=${VERSION}'" -o x-ui .

          mkdir -p release_temp/x-ui/bin
          cp x-ui release_temp/x-ui/

          # 创建 mock xray 二进制
          cat <<'XRAY_EOF' > release_temp/x-ui/bin/xray-linux-amd64
          #!/bin/sh
          if [ "$1" = "-version" ] || [ "$1" = "version" ]; then
          echo "Xray 1.8.4 (Mock) Custom"
          else
          echo "Starting Mock Xray..."
          sleep 3600
          fi
          XRAY_EOF
          chmod +x release_temp/x-ui/bin/xray-linux-amd64

          touch release_temp/x-ui/bin/geosite.dat
          touch release_temp/x-ui/bin/geoip.dat
          cp x-ui.sh release_temp/x-ui/ || touch release_temp/x-ui/x-ui.sh
          cp x-ui.service release_temp/x-ui/ || true

          cd release_temp
          tar -czf "${GITHUB_WORKSPACE}/x-ui-linux-amd64.tar.gz" x-ui
          cd ..
          rm -rf release_temp x-ui

      - name: Upload E2E tarball
        uses: actions/upload-artifact@v4
        with:
          name: e2e-tarball
          path: x-ui-linux-amd64.tar.gz
          retention-days: 1

  e2e-test:
    name: "E2E: ${{ matrix.test }}"
    needs: [e2e-build]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        test:
          [
            TestInstallation,
            TestCertApplication,
            TestSSLFallback,
            TestSIGHUPRestart,
          ]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Download E2E tarball
        uses: actions/download-artifact@v4
        with:
          name: e2e-tarball

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build E2E Image (Cached)
        uses: docker/build-push-action@v6
        with:
          context: .
          file: tests/e2e/docker/Dockerfile.ubuntu22
          tags: xpanel-e2e-image:latest
          push: false
          load: true
          cache-from: type=gha,scope=e2e-cache
          cache-to: type=gha,mode=max,scope=e2e-cache

      - name: Run E2E test (${{ matrix.test }})
        run: |
          # Testcontainers will use the pre-built image thanks to E2E_IMAGE env
          export E2E_IMAGE=xpanel-e2e-image:latest
          go test -v -timeout 15m ./tests/e2e/... -run TestE2E/${{ matrix.test }}

  # ===============================================================
  # Linux 平台的构建任务
  # ===============================================================
  build-linux:
    name: Build for Linux
    needs: [lint, nilaway, test, e2e-test] # ← 依赖所有 QA 检查通过
    permissions:
      contents: write
    strategy:
      matrix:
        platform:
          - amd64
          - arm64
          - armv7
          - armv6
          - 386
          - armv5
          - s390x
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          check-latest: true
          cache: false

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ matrix.platform }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.platform }}-

      - name: Resolve Bootlin Arch
        id: bootlin
        run: |
          case "${{ matrix.platform }}" in
            amd64) echo "ARCH=x86-64" >> $GITHUB_OUTPUT ;;
            arm64) echo "ARCH=aarch64" >> $GITHUB_OUTPUT ;;
            armv7) echo "ARCH=armv7-eabihf" >> $GITHUB_OUTPUT ;;
            armv6) echo "ARCH=armv6-eabihf" >> $GITHUB_OUTPUT ;;
            armv5) echo "ARCH=armv5-eabi" >> $GITHUB_OUTPUT ;;
            386) echo "ARCH=x86-i686" >> $GITHUB_OUTPUT ;;
            s390x) echo "ARCH=s390x-z13" >> $GITHUB_OUTPUT ;;
          esac

      - name: Cache Bootlin Toolchain
        id: cache-bootlin
        uses: actions/cache@v4
        with:
          path: /tmp/bootlin-toolchain
          key: bootlin-${{ steps.bootlin.outputs.ARCH }}-v1

      - name: Build X-Panel for Linux
        run: |
          export CGO_ENABLED=1
          export GOOS=linux
          export GOARCH=${{ matrix.platform }}
          # Use Bootlin prebuilt cross-toolchains (musl 1.2.5 in stable series)
          case "${{ matrix.platform }}" in
            amd64) BOOTLIN_ARCH="x86-64" ;;
            arm64) BOOTLIN_ARCH="aarch64" ;;
            armv7) BOOTLIN_ARCH="armv7-eabihf"; export GOARCH=arm GOARM=7 ;;
            armv6) BOOTLIN_ARCH="armv6-eabihf"; export GOARCH=arm GOARM=6 ;;
            armv5) BOOTLIN_ARCH="armv5-eabi"; export GOARCH=arm GOARM=5; export CGO_ENABLED=0 ;;
            386) BOOTLIN_ARCH="x86-i686" ;;
            s390x) BOOTLIN_ARCH="s390x-z13" ;;
          esac
          TOOLCHAIN_ROOT="/tmp/bootlin-toolchain"
          if [ -d "$TOOLCHAIN_ROOT" ] && [ -n "$(ls -A "$TOOLCHAIN_ROOT")" ]; then
             echo "Using cached toolchain from $TOOLCHAIN_ROOT"
          else
             echo "Resolving Bootlin musl toolchain for arch=$BOOTLIN_ARCH (platform=${{ matrix.platform }})"
             TARBALL_BASE="https://toolchains.bootlin.com/downloads/releases/toolchains/$BOOTLIN_ARCH/tarballs/"
             TARBALL_URL=$(curl -fsSL "$TARBALL_BASE" | grep -oE "${BOOTLIN_ARCH}--musl--stable-[^\"]+\\.tar\\.xz" | sort -r | head -n1)
             [ -z "$TARBALL_URL" ] && { echo "Failed to locate Bootlin musl toolchain for arch=$BOOTLIN_ARCH" >&2; exit 1; }
             echo "Downloading: $TARBALL_URL"
             
             cd /tmp
             curl -fL -sS -o "$(basename "$TARBALL_URL")" "$TARBALL_BASE/$TARBALL_URL"
             tar -xf "$(basename "$TARBALL_URL")"
             EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "${BOOTLIN_ARCH}--musl--stable-*" | head -n1)
             
             mkdir -p "$TOOLCHAIN_ROOT"
             mv "$EXTRACTED_DIR"/* "$TOOLCHAIN_ROOT/"
             # Cleanup
             rm -f "$(basename "$TARBALL_URL")"
             rmdir "$EXTRACTED_DIR"
             cd -
          fi

          export PATH="$TOOLCHAIN_ROOT/bin:$PATH"
          export CC=$(realpath "$(find "$TOOLCHAIN_ROOT/bin" -name '*-gcc.br_real' -type f -executable | head -n1)")
          [ -z "$CC" ] && { echo "No gcc.br_real found in $TOOLCHAIN_ROOT/bin" >&2; exit 1; }
          if [ "${{ matrix.platform }}" = "armv5" ]; then
            go build -ldflags "-w -s" -o xui-release -v .
          else
            go build -ldflags "-w -s -linkmode external -extldflags '-static'" -o xui-release -v .
          fi
          file xui-release
          ldd xui-release || echo "Static binary confirmed"

          mkdir x-ui
          cp xui-release x-ui/
          cp x-ui.service x-ui/
          cp x-ui.sh x-ui/
          cp -r sni x-ui/
          mv x-ui/xui-release x-ui/x-ui
          mkdir x-ui/bin
          cd x-ui/bin

          # Download dependencies
          Xray_URL="https://github.com/XTLS/Xray-core/releases/latest/download/"
          if [ "${{ matrix.platform }}" == "amd64" ]; then
            wget -q ${Xray_URL}Xray-linux-64.zip
            unzip Xray-linux-64.zip
            rm -f Xray-linux-64.zip
          elif [ "${{ matrix.platform }}" == "arm64" ]; then
            wget -q ${Xray_URL}Xray-linux-arm64-v8a.zip
            unzip Xray-linux-arm64-v8a.zip
            rm -f Xray-linux-arm64-v8a.zip
          elif [ "${{ matrix.platform }}" == "armv7" ]; then
            wget -q ${Xray_URL}Xray-linux-arm32-v7a.zip
            unzip Xray-linux-arm32-v7a.zip
            rm -f Xray-linux-arm32-v7a.zip
          elif [ "${{ matrix.platform }}" == "armv6" ]; then
            wget -q ${Xray_URL}Xray-linux-arm32-v6.zip
            unzip Xray-linux-arm32-v6.zip
            rm -f Xray-linux-arm32-v6.zip
          elif [ "${{ matrix.platform }}" == "386" ]; then
            wget -q ${Xray_URL}Xray-linux-32.zip
            unzip Xray-linux-32.zip
            rm -f Xray-linux-32.zip
          elif [ "${{ matrix.platform }}" == "armv5" ]; then
            wget -q ${Xray_URL}Xray-linux-arm32-v5.zip
            unzip Xray-linux-arm32-v5.zip
            rm -f Xray-linux-arm32-v5.zip
          elif [ "${{ matrix.platform }}" == "s390x" ]; then
            wget -q ${Xray_URL}Xray-linux-s390x.zip
            unzip Xray-linux-s390x.zip
            rm -f Xray-linux-s390x.zip
          fi
          rm -f geoip.dat geosite.dat
          wget -q https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
          wget -q https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat
          wget -q -O geoip_IR.dat https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geoip.dat
          wget -q -O geosite_IR.dat https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geosite.dat
          wget -q -O geoip_RU.dat https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geoip.dat
          wget -q -O geosite_RU.dat https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geosite.dat
          mv xray xray-linux-${{ matrix.platform }}
          cd ../..

      - name: Package
        run: tar -zcvf x-ui-linux-${{ matrix.platform }}.tar.gz x-ui

      - name: Upload files to Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: x-ui-linux-${{ matrix.platform }}
          path: ./x-ui-linux-${{ matrix.platform }}.tar.gz

      - name: Upload files to GH release
        uses: svenstaro/upload-release-action@v2
        if: github.event_name == 'release' && github.event.action == 'published'
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: x-ui-linux-${{ matrix.platform }}.tar.gz
          asset_name: x-ui-linux-${{ matrix.platform }}.tar.gz
          prerelease: true

  # ===============================================================
  # Windows 平台的构建任务
  # ===============================================================
  build-windows:
    name: Build for Windows
    needs: [lint, nilaway, test, e2e-test] # ← 依赖所有 QA 检查通过
    permissions:
      contents: write
    strategy:
      matrix:
        platform:
          - amd64
          - 386
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          check-latest: true
          cache: false

      - name: Cache Go Modules
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\go-build
            ~\go\pkg\mod
          key: ${{ runner.os }}-go-${{ matrix.platform }}-${{ hashFiles('go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-${{ matrix.platform }}-

      - name: Build X-Panel for Windows
        shell: pwsh
        run: |
          $env:GOOS = "windows"
          $env:GOARCH = "${{ matrix.platform }}"
          $env:CGO_ENABLED = "0"

          # 1. 编译 Go 程序
          go build -ldflags "-w -s" -o x-ui-release.exe -v .

          # 2. 创建主目录
          mkdir x-ui

          # 3. 移动主程序
          Move-Item -Path .\x-ui-release.exe -Destination .\x-ui\x-ui.exe

          # 4. 【修正】在进入 bin 目录之前，从根目录复制 sni 到 x-ui 文件夹
          if (Test-Path .\sni) {
              Copy-Item -Path .\sni -Destination .\x-ui -Recurse
          } else {
              Write-Host "Warning: sni directory not found at root, skipping."
          }

          # 5. 创建并进入 bin 目录下载依赖
          mkdir x-ui\bin
          cd x-ui\bin

          # 下载 Xray 依赖
          $Xray_URL="https://github.com/XTLS/Xray-core/releases/latest/download/"
          if ("${{ matrix.platform }}" -eq "amd64") {
            Invoke-WebRequest -Uri "${Xray_URL}Xray-windows-64.zip" -OutFile "xray.zip"
          } elseif ("${{ matrix.platform }}" -eq "386") {
            Invoke-WebRequest -Uri "${Xray_URL}Xray-windows-32.zip" -OutFile "xray.zip"
          }

          Expand-Archive -Path .\xray.zip -DestinationPath .
          Remove-Item -Path .\xray.zip

          # 下载 Geo 文件
          Remove-Item -Path "geoip.dat", "geosite.dat" -ErrorAction SilentlyContinue
          Invoke-WebRequest -Uri "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat" -OutFile "geoip.dat"
          Invoke-WebRequest -Uri "https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat" -OutFile "geosite.dat"
          Invoke-WebRequest -Uri "https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geoip.dat" -OutFile "geoip_IR.dat"
          Invoke-WebRequest -Uri "https://github.com/chocolate4u/Iran-v2ray-rules/releases/latest/download/geosite.dat" -OutFile "geosite_IR.dat"
          Invoke-WebRequest -Uri "https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geoip.dat" -OutFile "geoip_RU.dat"
          Invoke-WebRequest -Uri "https://github.com/runetfreedom/russia-v2ray-rules-dat/releases/latest/download/geosite.dat" -OutFile "geosite_RU.dat"

          # 重命名 xray
          Move-Item -Path .\xray.exe -Destination "xray-windows-${{ matrix.platform }}.exe"

          # 6. 返回上一级 (x-ui 目录)
          cd ..

          # 7. 复制 windows_files (从项目根目录复制)
          if (Test-Path ..\windows_files) {
              Copy-Item -Path ..\windows_files\* -Destination . -Recurse
          } else {
              Write-Host "Warning: windows_files directory not found, skipping."
          }

          # 8. 返回项目根目录
          cd ..

      - name: Package to Zip
        shell: pwsh
        run: |
          Compress-Archive -Path .\x-ui -DestinationPath "x-ui-windows-${{ matrix.platform }}.zip"

      - name: Upload files to Artifacts
        uses: actions/upload-artifact@v6
        with:
          name: x-ui-windows-${{ matrix.platform }}
          path: ./x-ui-windows-${{ matrix.platform }}.zip

      - name: Upload files to GH release
        uses: svenstaro/upload-release-action@v2
        if: github.event_name == 'release' && github.event.action == 'published'
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          file: x-ui-windows-${{ matrix.platform }}.zip
          asset_name: x-ui-windows-${{ matrix.platform }}.zip
          prerelease: true
