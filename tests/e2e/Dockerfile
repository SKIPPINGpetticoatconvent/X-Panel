# ----------------------------------------
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º (Build Stage)
# ----------------------------------------
FROM golang:alpine AS builder

WORKDIR /app
# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache build-base gcc git wget unzip

# å¤åˆ¶æºç 
COPY . .

# è¿è¡Œåˆå§‹åŒ–è„šæœ¬ (ä¸‹è½½ geoip.dat / geosite.dat)
ARG TARGETARCH
RUN if [ -f DockerInit.sh ]; then \
      chmod +x DockerInit.sh && ./DockerInit.sh "$TARGETARCH"; \
    fi

# ç¼–è¯‘åº”ç”¨
ENV CGO_ENABLED=1
RUN go build -ldflags "-w -s" -o x-ui main.go

# ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šåˆ›å»ºä¸€ä¸ªç»Ÿä¸€çš„è¾“å‡ºç›®å½•ï¼Œæ•´ç†æ‰€æœ‰æ–‡ä»¶
# è¿™æ ·å¯ä»¥é¿å… Runtime é˜¶æ®µ COPY å¤±è´¥
RUN mkdir -p /output/bin

# 1. å¤åˆ¶ä¸»ç¨‹åº
RUN cp x-ui /output/

# 2. å¤åˆ¶ .dat æ–‡ä»¶åˆ° /output/bin (å¦‚æœå­˜åœ¨)
RUN if ls *.dat 1> /dev/null 2>&1; then cp *.dat /output/bin/; fi

# 3. å¤åˆ¶ bin ç›®å½•ä¸‹çš„å†…å®¹ (å¦‚æœå­˜åœ¨)
RUN if [ -d bin ]; then cp -r bin/* /output/bin/; fi

# 4. å¤åˆ¶ x-ui.sh (å¦‚æœå­˜åœ¨)
RUN if [ -f x-ui.sh ]; then cp x-ui.sh /output/; fi

# ----------------------------------------
# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ (Runtime Stage)
# ----------------------------------------
FROM alpine:latest
WORKDIR /app
ENV TZ=Asia/Shanghai

# å®‰è£…è¿è¡Œæ—¶ä¾èµ– + æµ‹è¯•å·¥å…· (sqlite)
RUN apk add --no-cache ca-certificates tzdata fail2ban bash curl sqlite

# ğŸŸ¢ å…³é”®ä¿®æ”¹ï¼šä» builder çš„è¾“å‡ºç›®å½•ä¸€æ¬¡æ€§å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
# è¿™æ ·ä¿è¯æ–‡ä»¶ç»“æ„æ­£ç¡®ï¼Œä¸”ä¸ä¼šå› ä¸ºç¼ºå°‘æŸä¸ªæ–‡ä»¶æŠ¥é”™
COPY --from=builder /output/ /app/

# å¤åˆ¶æµ‹è¯•å¯åŠ¨è„šæœ¬
COPY tests/e2e/entrypoint.sh /app/test_entrypoint.sh
RUN chmod +x /app/test_entrypoint.sh

# ç¯å¢ƒå˜é‡
ENV XPANEL_RUN_IN_CONTAINER=true
ENV XUI_ENABLE_FAIL2BAN=false

# ç«¯å£ä¸å·
EXPOSE 13688
VOLUME [ "/etc/x-ui" ]

# å…¥å£
ENTRYPOINT ["/app/test_entrypoint.sh"]