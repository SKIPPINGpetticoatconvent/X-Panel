# ----------------------------------------
# ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º (Build Stage)
# ----------------------------------------
FROM golang:1.24-alpine AS builder
WORKDIR /app
# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache build-base gcc git
# å¤åˆ¶æºç 
COPY . .
# ç¼–è¯‘åº”ç”¨
ENV CGO_ENABLED=1
RUN go build -ldflags "-w -s" -o x-ui main.go

# ----------------------------------------
# ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ (Runtime Stage)
# ----------------------------------------
FROM alpine:latest
WORKDIR /app
ENV TZ=Asia/Shanghai

# å®‰è£…è¿è¡Œæ—¶ä¾èµ– + æµ‹è¯•å·¥å…· (sqlite)
# ğŸ”´ å…³é”®ç‚¹ï¼šè¿™é‡Œç›´æ¥è£…å¥½äº† sqliteï¼Œä¸ç”¨åœ¨è¿è¡Œæ—¶ä¸‹è½½
RUN apk add --no-cache ca-certificates tzdata fail2ban bash curl sqlite

# ä»æ„å»ºé˜¶æ®µå¤åˆ¶æ–‡ä»¶
COPY --from=builder /app/x-ui /app/
COPY --from=builder /app/bin /app/bin/ 2>/dev/null || true

# å¤åˆ¶åŸæœ¬çš„èµ„æºæ–‡ä»¶ (æ ¹æ®ä½ çš„é¡¹ç›®ç»“æ„ï¼Œç¡®ä¿è¿™äº›å­˜åœ¨)
# å¦‚æœä½ çš„é¡¹ç›®é‡Œæœ‰ x-ui.sh æˆ–å…¶ä»–èµ„æºï¼Œä¿ç•™å®ƒä»¬
# COPY x-ui.sh /usr/bin/x-ui

# ğŸ”´ å…³é”®ç‚¹ï¼šå¤åˆ¶æˆ‘ä»¬çš„æµ‹è¯•å¯åŠ¨è„šæœ¬
COPY tests/e2e/entrypoint.sh /app/test_entrypoint.sh
RUN chmod +x /app/test_entrypoint.sh

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV XPANEL_RUN_IN_CONTAINER=true
ENV XUI_ENABLE_FAIL2BAN=false

# æš´éœ²ç«¯å£
EXPOSE 13688

# è®¾ç½®æ•°æ®å·
VOLUME [ "/etc/x-ui" ]

# ğŸ”´ å…³é”®ç‚¹ï¼šä½¿ç”¨æµ‹è¯•è„šæœ¬ä½œä¸ºå…¥å£
ENTRYPOINT ["/app/test_entrypoint.sh"]