# CentOS测试环境 Dockerfile
# 用于测试防火墙自动安装功能

FROM centos:7

# 设置环境变量
ENV TEST_OS_TYPE=centos
ENV SKIP_REAL_INSTALL_TESTS=true

# 安装基础依赖
RUN yum update -y && yum install -y \
    curl \
    wget \
    git \
    gcc \
    gcc-c++ \
    make \
    sudo \
    systemd \
    systemd-sysv \
    iptables \
    procps-ng \
    net-tools \
    which \
    && yum clean all \
    && rm -rf /var/cache/yum/*

# 安装Go语言环境
RUN curl -fsSL https://go.dev/dl/go1.21.5.linux-amd64.tar.gz | tar -xzC /usr/local && \
    echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile && \
    echo 'export PATH=$PATH:/usr/local/go/bin' >> /root/.bashrc

# 设置工作目录
WORKDIR /app

# 复制项目文件
COPY . .

# 构建项目
RUN go mod download && \
    go build -o x-ui

# 创建测试用户（可选）
RUN useradd -m -s /bin/bash testuser && \
    echo "testuser ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# 设置SSH服务（用于测试防火墙SSH端口检测）
RUN mkdir -p /run/sshd && \
    echo 'Port 2222' >> /etc/ssh/sshd_config && \
    echo 'PermitRootLogin yes' >> /etc/ssh/sshd_config && \
    echo 'PasswordAuthentication yes' >> /etc/ssh/sshd_config

# 设置测试用的脚本入口
COPY tests/docker/centos-test-entrypoint.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/centos-test-entrypoint.sh

# 暴露测试端口
EXPOSE 2222 8080

# 设置标签
LABEL maintainer="x-ui-test"
LABEL description="CentOS test environment for firewall auto-install testing"
LABEL version="1.0"

# 注意：在容器中运行systemd需要特权模式
# 启动命令需要使用: --privileged --entrypoint=/bin/bash
# 或者使用systemd-nspawn等容器技术

ENTRYPOINT ["/usr/local/bin/centos-test-entrypoint.sh"]