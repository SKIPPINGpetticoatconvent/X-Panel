# SNI 域名智能优选与轮询 (SNI Selection with GeoIP Integration)

`SNISelector` 是 X-Panel 在 v2.2.0 引入的核心组件，通过集成 GeoIP 地理位置检测服务，实现智能的地理位置感知 SNI 域名选择功能。该系统不仅确保在生成多个节点时自动轮询使用不同的 SNI 域名，还能根据服务器所在地理位置自动选择最适合的域名列表。

## 1. 核心功能

### 1.1 智能地理位置检测
*   **自动地理位置识别**：系统启动时自动检测服务器所在的地理位置
*   **多 API 支持**：集成多个地理位置检测服务，确保可靠性
*   **智能缓存**：地理位置信息缓存 1 小时，避免频繁 API 调用
*   **优雅降级**：API 不可用时自动使用默认设置

### 1.2 地理位置感知 SNI 选择
*   **智能去重**：在连续生成节点时，优先使用未使用的 SNI 域名
*   **自动洗牌 (Shuffle)**：当所有可用域名都被使用过一轮后，系统会自动重置并将列表重新打乱
*   **地理位置优化**：根据服务器所在地区自动选择对应国家的 SNI 域名列表
*   **并发安全**：支持多用户同时请求，保证在高并发环境下也不会分配重复的域名
*   **优雅降级**：如果未配置对应国家的 SNI 列表，系统会自动回退到默认的国际通用域名
*   **统一服务架构**：SNI 选择功能作为共享服务，同时支持 Telegram Bot 和网页端

## 2. 工作原理

### 2.1 GeoIP 地理位置检测流程

系统启动时会自动执行以下步骤：

1.  **IP 获取**：尝试从多个 API 服务获取服务器公网 IP
   - `https://api4.ipify.org`
   - `https://ipv4.icanhazip.com`
   - `https://v4.api.ipinfo.io/ip`

2.  **地理位置检测**：使用检测到的 IP 进行地理位置查询
   - `https://api.myip.la/en?json` (主要 API)
   - `https://api.ip.sb/geoip` (备用 API)
   - **自动回退机制**：主 API 失败时自动切换到备用 API，确保服务高可用性

3.  **国家代码标准化**：将获取的地理位置信息转换为标准 ISO 国家代码
4.  **缓存存储**：将结果缓存 1 小时，提高性能

### 2.2 SNI 域名选择流程

`SNISelector` 维护一个内存中的域名列表和一个指向当前域名的索引。

1.  **初始化**：
    - 系统启动时，根据检测到的国家代码加载对应的 SNI 域名文件
    - 如果文件不存在或为空，使用内置的默认域名列表
    - 对域名列表进行第一次随机洗牌

2.  **获取域名 (`Next()`)**：
    - 每次请求时，返回当前索引指向的域名
    - 索引自动递增
    - 记录详细的日志信息用于调试

3.  **重置与洗牌**：
    - 当索引达到列表末尾（即所有域名都已使用一次）时，索引重置为 0
    - 触发洗牌算法 (Fisher-Yates Shuffle)，将列表顺序完全打乱
    - 日志记录：`SNI selector reshuffled, starting new round with X domains`

## 3. 支持的国家/地区

### 3.1 预配置的国家/地区列表

系统为以下国家/地区提供了专门的 SNI 域名列表：

| 国家/地区 | 代码 | 文件路径 | 域名数量 | 特色域名类型 |
|-----------|------|----------|----------|--------------|
| 美国 | US | `sni/US/sni_domains.txt` | 24+ | 科技巨头、电商平台 |
| 日本 | JP | `sni/JP/sni_domains.txt` | 24+ | 本土品牌、日企 |
| 英国 | UK/GB | `sni/UK/sni_domains.txt` | 23+ | 媒体、政府机构 |
| 韩国 | KR | `sni/KR/sni_domains.txt` | 20+ | 韩国企业 |

### 3.2 默认国际通用域名

如果无法检测到具体国家或对应国家的文件不存在，系统会使用国际通用域名：

```
tesla.com:443
sega.com:443
apple.com:443
icloud.com:443
lovelive-anime.jp:443
meta.com:443
```

## 4. 配置指南

### 4.1 自定义 SNI 域名列表

如果您希望为特定国家/地区自定义 SNI 域名，可以按照以下步骤操作：

1.  **找到对应国家的文件**：位于 `sni/{CountryCode}/sni_domains.txt`
2.  **编辑文件内容**：每行一个域名，支持的格式：
   - `domain.com`
   - `domain.com:443`
   - `"domain.com:443"` (带引号)
   - `domain.com:443,` (带逗号)

3.  **重启面板应用更改**

**示例文件内容 (`sni/US/sni_domains.txt`)**：
```text
www.google.com
www.amazon.com:443
"www.microsoft.com:443",
cdn.discordapp.com
www.netflix.com
```

### 4.2 地理位置检测配置

GeoIP 服务默认使用以下配置：

- **主要 API**：`https://api.myip.la/en?json`
- **备用 API**：`https://api.ip.sb/geoip`
- **超时设置**：10 秒
- **重试次数**：3 次（指数退避策略）
- **缓存时间**：1 小时
- **默认回退**：USA
- **高可用性**：主 API 失败时自动切换到备用 API，确保服务连续性

### 4.3 验证配置

您可以通过以下方式验证 GeoIP 和 SNI 选择功能：

1. **查看面板日志**：
```bash
journalctl -u x-ui -f
```

2. **关键日志信息**：
   - `GeoIP 位置获取成功: 美国 (US)`
   - `SNI selector initialized with 24 domains`
   - `SNI selector selected domain: www.google.com:443 (index: 5)`
   - `SNI selector reshuffled, starting new round with 24 domains`

3. **API 接口测试**（如果启用）：
   ```bash
   curl http://localhost:8080/server/getNewSNI
   ```

## 5. 故障排除

### 5.1 常见问题及解决方案

#### 5.1.1 GeoIP 检测失败

**症状**：日志显示 "GeoIP 获取失败，使用默认国家代码"

**可能原因**：
- 网络连接问题
- 主要 GeoIP API 服务不可用
- 备用 GeoIP API 服务不可用
- 服务器无法访问外网

**解决方案**：
1. 检查服务器网络连接
2. 验证防火墙设置，确保可以访问外部 API
3. 测试两个 GeoIP API 的连通性：
   - 测试主 API：`curl -m 10 https://api.myip.la/en?json`
   - 测试备用 API：`curl -m 10 https://api.ip.sb/geoip`
4. 系统会自动使用 "USA" 作为默认回退

#### 5.1.2 SNI 域名文件不存在

**症状**：日志显示 "读取 sni/{CountryCode}/sni_domains.txt 文件失败"

**解决方案**：
1. 确保对应的目录和文件存在
2. 检查文件权限（面板用户需要读取权限）
3. 系统会自动使用对应国家的默认域名列表

#### 5.1.3 域名选择重复

**症状**：连续生成的节点使用了相同的 SNI 域名

**解决方案**：
1. 检查 SNI 域名文件内容，确保包含足够的不同域名
2. 查看面板日志，确认洗牌功能正常工作
3. 考虑添加更多域名到列表中

### 5.2 高级故障排除

#### 5.2.1 调试模式启用

在面板设置中启用调试级别日志，可以获得更详细的运行信息：

```bash
# 查看最新的调试日志
journalctl -u x-ui -f -p debug
```

#### 5.2.2 手动触发刷新

如果需要手动刷新 SNI 域名列表（不重启面板），可以通过 API 调用：

```bash
curl -X POST http://localhost:8080/server/refreshSNI
```

## 6. 安全与性能

### 6.1 并发安全性
`SNISelector` 内部使用 `sync.Mutex` 互斥锁保护状态访问。这意味着即使有多个用户同时通过 Telegram Bot 或网页端请求生成节点，系统也能保证状态的一致性，不会出现"跳过"或"竞争"导致的问题。

### 6.2 性能优化

#### 6.2.1 缓存机制
- **GeoIP 缓存**：1 小时内的地理位置查询会使用缓存结果
- **DNS 缓存**：域名解析结果由操作系统自动缓存
- **内存管理**：SNI 域名列表在内存中维护，避免频繁文件 I/O

#### 6.2.2 网络优化
- **超时控制**：所有网络请求都有合理的超时设置
- **重试策略**：使用指数退避算法避免对 API 服务造成压力
- **备用服务**：多个地理位置 API 提供服务可用性保障

### 6.3 统一服务架构

通过将 SNI 选择功能重构为共享服务，我们实现了：

- **代码复用**：Telegram Bot 和网页端共享相同的 SNI 选择逻辑
- **功能一致性**：两个平台提供完全相同的 SNI 域名选择体验
- **维护简化**：只需要维护一套 SNI 选择代码，降低了维护成本
- **扩展性**：未来可以轻松为其他功能模块集成 SNI 选择能力

### 6.4 回退机制 (Fallback)

系统设计了多层次的回退机制：

1. **GeoIP API 回退**：主要 API 失败时自动切换到备用 API
   - 主 API：`https://api.myip.la/en?json`
   - 备用 API：`https://api.ip.sb/geoip`
   - 两个 API 都失败时返回统一错误信息
2. **国家代码回步**：无法识别国家时使用 "USA" 默认值
3. **SNI 文件回退**：国家文件不存在时使用对应国家的内置默认列表
4. **域名列表回退**：所有列表都不可用时使用国际通用域名

## 7. 网页端支持

从 v2.2.0 版本开始，网页端也完全支持 SNI 域名智能选择功能：

### 7.1 统一体验
- **地理位置感知**：网页端同样会根据服务器地理位置自动选择对应的 SNI 域名列表
- **实时域名**：在创建 Reality 或 XHTTP+Reality 节点时，网页端会自动应用 SNI 域名轮询
- **智能去重**：确保用户连续创建的多个节点使用不同的 SNI 域名

### 7.2 使用示例
在网页端的"入站"页面创建新节点时，选择 Reality 协议类型，系统会自动：
1. 根据服务器位置加载对应国家的 SNI 域名列表
2. 智能选择一个未重复使用的域名
3. 自动配置到节点的 SNI 设置中

### 7.3 日志监控
通过面板日志可以监控网页端的 SNI 域名选择过程：
- 地理位置检测结果
- SNI 域名列表加载状态
- 域名选择和轮询过程

## 8. API 接口

系统提供了以下 API 接口供前端和第三方服务调用：

### 8.1 获取下一个 SNI 域名
```
GET /server/getNewSNI
```

**响应**：
```json
{
  "success": true,
  "data": "www.google.com:443"
}
```

### 8.2 服务端日志监控
您可以通过查看面板日志来监控 SNI 选择过程：

```bash
journalctl -u x-ui -f
```

**关键日志信息**：
- `GeoIP 位置获取成功: 美国 (US)`
- `SNI selector initialized with 24 domains`
- `SNI selector selected domain: www.google.com:443 (index: 5)`
- `SNI selector reshuffled, starting new round with 24 domains`

## 9. 未来改进与安全建议

根据最近的安全审查和性能分析，我们在未来版本中计划引入以下改进：

### 9.1 安全增强
- **文件路径安全验证**：增强对加载 SNI 文件路径的检查，防止路径遍历风险
- **域名格式校验**：在加载列表时增加正则表达式校验，自动过滤格式错误的域名
- **API 频率限制**：添加对外部 API 的调用频率限制，避免被限流

### 9.2 功能扩展
- **动态热更新**：支持在不重启面板的情况下，通过 API 或命令重新加载 SNI 列表
- **自定义地理区域**：允许管理员定义自定义地理区域和对应的域名列表
- **域名健康检查**：定期检查域名可用性，自动移除不可用的域名
- **性能监控**：添加 SNI 选择功能的性能监控和统计信息

### 9.3 用户体验优化
- **可视化配置**：在网页端提供图形化界面来管理 SNI 域名列表
- **批量导入**：支持批量导入域名列表，支持多种格式
- **使用统计**：显示域名使用频率和统计数据

---

**注意**：本功能需要服务器能够访问外部网络以服务器获取地理位置信息。如果在受限网络环境中，请确保能够访问相关的地理位置 API 服务。