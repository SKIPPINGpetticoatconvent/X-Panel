# SNI 域名优选与轮询 (SNI Selection)

`SNISelector` 是 X-Panel 在 v2.2.0 (假设版本，或泛指最新版) 引入的一个核心组件，旨在优化 Telegram Bot “一键配置”功能生成的节点质量。它确保在生成多个节点时，自动轮询使用不同的 SNI 域名，避免重复，从而降低被防火墙针对的风险。

## 1. 核心功能

*   **智能去重**：在连续生成节点时，优先使用未使用的 SNI 域名。
*   **自动洗牌 (Shuffle)**：当所有可用域名都被使用过一轮后，系统会自动重置并将列表重新打乱，开始新的一轮循环。这确保了域名的使用分布是均匀且随机的。
*   **并发安全**：支持多用户同时请求，保证在高并发环境下也不会分配重复的域名（在列表容量允许的范围内）。
*   **优雅降级**：如果未配置 SNI 列表或列表为空，系统会自动回退到默认的安全域名或随机选择模式。
*   **统一服务架构**：SNI选择功能已重构为共享服务，同时支持Telegram Bot和网页端，确保功能一致性和代码复用。

## 2. 工作原理

`SNISelector` 维护一个内存中的域名列表和一个指向当前域名的索引。

1.  **初始化**：Bot 启动时，从配置文件或内置列表中加载 SNI 域名，并进行第一次随机洗牌。
2.  **获取域名 (`Next()`)**：
    *   每次请求时，返回当前索引指向的域名。
    *   索引加 1。
3.  **重置与洗牌**：
    *   当索引达到列表末尾（即所有域名都已使用一次）时，索引重置为 0。
    *   **关键步骤**：触发洗牌算法 (Fisher-Yates Shuffle)，将列表顺序完全打乱。
    *   日志记录：`SNI selector reshuffled, starting new round...`

这种机制保证了即使是同一个用户连续生成 10 个节点，只要 SNI 列表中有至少 10 个域名，这 10 个节点的 SNI 就会完全不同。

## 3. 配置指南

### 3.1 SNI 列表来源

SNI 列表来源于服务器地理位置对应的默认列表，同时为TG Bot和网页端提供统一的数据源。

*   **文件位置**: `sni/<CountryCode>/sni_domains.txt` (例如 `sni/US/sni_domains.txt`)
*   **加载逻辑**: 系统启动时，根据服务器 IP 自动识别国家/地区，并加载对应的 SNI 文件。
*   **共享服务**: `SNISelector` 作为共享服务，同时为Telegram Bot和网页端提供SNI域名选择功能。

### 3.2 如何修改 SNI 列表

如果您希望自定义用于生成节点的 SNI 域名，可以按照以下步骤操作：

1.  找到您的服务器对应的 SNI 列表文件（位于 `sni/` 目录下）。
2.  编辑该文件，每行一个域名。
3.  **重启面板**以应用更改。

**注意**: 修改SNI列表将同时影响Telegram Bot和网页端的SNI域名选择功能。

**示例 (`sni/US/sni_domains.txt`)**:
```text
www.google.com
www.amazon.com
www.microsoft.com
cdn.discordapp.com
...
```

### 3.3 验证配置

您可以通过查看面板日志来验证 `SNISelector` 是否正常工作：

```bash
journalctl -u x-ui -f
```

当您使用 TG Bot 或网页端生成节点时，您应该能看到类似以下的日志（如果 Log Level 设置为 Debug）：
`SNI selector selected domain: example.com (index: 5)`

## 3.4 网页端支持

从v2.2.0版本开始，网页端也完全支持SNI域名优选功能：

*   **统一体验**: 网页端和Telegram Bot使用相同的SNI选择逻辑，确保功能一致性。
*   **实时域名**: 在创建Reality或XHTTP+Reality节点时，网页端会自动应用SNI域名轮询。
*   **地理位置优化**: 网页端同样会根据服务器地理位置自动选择对应的SNI域名列表。
*   **日志监控**: 通过面板日志可以监控网页端的SNI域名选择过程。

**使用示例**：
在网页端的"入站"页面创建新节点时，选择Reality协议类型，系统会自动：
1. 根据服务器位置加载对应国家的SNI域名列表
2. 智能选择一个未重复使用的域名
3. 自动配置到节点的SNI设置中

## 4. 安全与性能

### 4.1 并发安全性
`SNISelector` 内部使用 `sync.Mutex` 互斥锁保护状态访问。这意味着即使有多个用户同时通过 TG Bot 或网页端请求生成节点，系统也能保证状态的一致性，不会出现“跳过”或“竞争”导致的问题。

### 4.2 统一服务架构
通过将SNI选择功能重构为共享服务，我们实现了：

*   **代码复用**: TG Bot和网页端共享相同的SNI选择逻辑
*   **功能一致性**: 两个平台提供完全相同的SNI域名选择体验
*   **维护简化**: 只需要维护一套SNI选择代码，降低了维护成本
*   **扩展性**: 未来可以轻松为其他功能模块集成SNI选择能力

### 4.2 回退机制 (Fallback)
如果在初始化时无法读取到任何 SNI 域名（例如文件丢失或为空），`SNISelector` 会自动使用内置的最小安全列表（如 `www.google.com`, `www.amazon.com`），确保服务不会因配置错误而中断。

## 5. 未来改进与安全建议

根据最近的安全审查，我们在未来版本中计划引入以下改进：

*   **文件路径安全验证**：增强对加载 SNI 文件路径的检查，防止路径遍历风险。
*   **域名格式校验**：在加载列表时增加正则表达式校验，自动过滤格式错误的域名。
*   **动态热更新**：支持在不重启面板的情况下，通过 API 或命令重新加载 SNI 列表。
