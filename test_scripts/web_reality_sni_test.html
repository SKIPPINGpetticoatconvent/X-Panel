<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘é¡µç«¯ Reality SNI ä¿®å¤éªŒè¯æµ‹è¯•</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-case {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        .pass {
            border-left: 4px solid #52c41a;
            background-color: #f6ffed;
        }
        .fail {
            border-left: 4px solid #ff4d4f;
            background-color: #fff2f0;
        }
        .test-title {
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 10px;
        }
        .input-output {
            margin: 5px 0;
            font-family: monospace;
        }
        .expected {
            color: #52c41a;
        }
        .actual {
            color: #722ed1;
        }
        .error {
            color: #ff4d4f;
            font-weight: bold;
        }
        .summary {
            margin-top: 30px;
            padding: 15px;
            background-color: #e6f7ff;
            border-radius: 5px;
            border: 1px solid #91d5ff;
        }
        .success {
            color: #52c41a;
            font-weight: bold;
        }
        .failure {
            color: #ff4d4f;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª ç½‘é¡µç«¯ Reality SNI ä¿®å¤éªŒè¯æµ‹è¯•</h1>
        <p>æœ¬æµ‹è¯•éªŒè¯ä¿®å¤åçš„ç½‘é¡µç«¯ SNI ç”Ÿæˆé€»è¾‘ï¼Œç¡®ä¿ä¸ä¼šç”Ÿæˆ "www.www." å‰ç¼€</p>
        
        <div id="test-results"></div>
        <div id="summary" class="summary"></div>
    </div>

    <script>
        // ã€ä¿®å¤åã€‘: æ™ºèƒ½çš„ SNI ç”Ÿæˆé€»è¾‘ï¼Œé¿å… www.www. å‰ç¼€
        function generateRealityServerNames(randomSni) {
            // æ£€æŸ¥æ˜¯å¦ä»¥ www. å¼€å¤´
            if (randomSni.startsWith('www.')) {
                // æƒ…å†µ A: è¾“å…¥ www.oracle.com -> ["www.oracle.com", "oracle.com"]
                const rootDomain = randomSni.substring(4); // å»é™¤ www.
                return [randomSni, rootDomain];
            } else {
                // æƒ…å†µ B: è¾“å…¥ oracle.com -> ["oracle.com", "www.oracle.com"]
                return [randomSni, `www.${randomSni}`];
            }
        }

        // æµ‹è¯•ç”¨ä¾‹
        const testCases = [
            {
                name: "Test www.oracle.com:443 - should NOT generate www.www.oracle.com",
                input: "www.oracle.com:443",
                expected: ["www.oracle.com", "oracle.com"],
                extractDomain: function(input) {
                    return input.split(':')[0]; // å»é™¤ç«¯å£å·
                }
            },
            {
                name: "Test oracle.com:443 - should generate both with and without www",
                input: "oracle.com:443",
                expected: ["oracle.com", "www.oracle.com"],
                extractDomain: function(input) {
                    return input.split(':')[0]; // å»é™¤ç«¯å£å·
                }
            },
            {
                name: "Test www.www.oracle.com - edge case with double www",
                input: "www.www.oracle.com:443",
                expected: ["www.www.oracle.com", "www.oracle.com"],
                extractDomain: function(input) {
                    return input.split(':')[0]; // å»é™¤ç«¯å£å·
                }
            },
            {
                name: "Test google.com - without port",
                input: "google.com",
                expected: ["google.com", "www.google.com"],
                extractDomain: function(input) {
                    return input.split(':')[0]; // å»é™¤ç«¯å£å·
                }
            },
            {
                name: "Test www.google.com - without port",
                input: "www.google.com",
                expected: ["www.google.com", "google.com"],
                extractDomain: function(input) {
                    return input.split(':')[0]; // å»é™¤ç«¯å£å·
                }
            }
        ];

        // éªŒè¯å‡½æ•°
        function arraysEqual(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }

        // æ£€æŸ¥æ˜¯å¦åŒ…å« www.www. æ¨¡å¼
        function containsWwwWwwPattern(arr) {
            return arr.some(domain => domain.includes('www.www.'));
        }

        // è¿è¡Œæµ‹è¯•
        function runTests() {
            const resultsContainer = document.getElementById('test-results');
            const summaryContainer = document.getElementById('summary');
            
            let passedTests = 0;
            let totalTests = testCases.length;
            let allPassed = true;

            testCases.forEach((testCase, index) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                
                // æå–åŸŸåï¼ˆå»é™¤ç«¯å£å·ï¼‰
                const domain = testCase.extractDomain(testCase.input);
                
                // è¿è¡Œä¿®å¤åçš„é€»è¾‘
                const result = generateRealityServerNames(domain);
                
                // æ£€æŸ¥ç»“æœ
                const testPassed = arraysEqual(result, testCase.expected);
                const hasWwwWwwPattern = containsWwwWwwPattern(result);
                
                if (testPassed && !hasWwwWwwPattern) {
                    testDiv.className += ' pass';
                } else {
                    testDiv.className += ' fail';
                    allPassed = false;
                }

                if (testPassed) {
                    passedTests++;
                }

                // æ„å»ºæµ‹è¯•ç»“æœHTML
                testDiv.innerHTML = `
                    <div class="test-title">ğŸ“ ${testCase.name}</div>
                    <div class="input-output"><strong>è¾“å…¥:</strong> ${testCase.input}</div>
                    <div class="input-output"><strong>æå–åŸŸå:</strong> ${domain}</div>
                    <div class="input-output expected"><strong>æœŸæœ›è¾“å‡º:</strong> [${testCase.expected.map(e => `"${e}"`).join(', ')}]</div>
                    <div class="input-output actual"><strong>å®é™…è¾“å‡º:</strong> [${result.map(r => `"${r}"`).join(', ')}]</div>
                    ${hasWwwWwwPattern ? '<div class="error">âŒ é”™è¯¯: å‘ç° "www.www." å‰ç¼€ï¼</div>' : ''}
                    ${testPassed ? '<div style="color: #52c41a; font-weight: bold;">âœ… æµ‹è¯•é€šè¿‡</div>' : '<div class="error">âŒ æµ‹è¯•å¤±è´¥</div>'}
                `;

                resultsContainer.appendChild(testDiv);
            });

            // æ˜¾ç¤ºæ€»ç»“
            summaryContainer.innerHTML = `
                <h3>ğŸ“Š æµ‹è¯•æ€»ç»“</h3>
                <p><strong>æ€»æµ‹è¯•æ•°:</strong> ${totalTests}</p>
                <p><strong>é€šè¿‡æµ‹è¯•:</strong> ${passedTests}</p>
                <p><strong>å¤±è´¥æµ‹è¯•:</strong> ${totalTests - passedTests}</p>
                <p><strong>é€šè¿‡ç‡:</strong> ${((passedTests / totalTests) * 100).toFixed(1)}%</p>
                <div class="${allPassed ? 'success' : 'failure'}">
                    ${allPassed ? 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç½‘é¡µç«¯ Reality SNI ä¿®å¤éªŒè¯æˆåŠŸ' : 'ğŸ’¥ å­˜åœ¨æµ‹è¯•å¤±è´¥ï¼Œéœ€è¦è¿›ä¸€æ­¥è°ƒè¯•'}
                </div>
                <div style="margin-top: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
                    <strong>æ ¸å¿ƒä¿®å¤:</strong><br>
                    âœ… ä¿®å¤å‰: <code>serverNames: [ randomSni, \`www.\${randomSni}\` ]</code><br>
                    âœ… ä¿®å¤å: ä½¿ç”¨æ™ºèƒ½åˆ¤æ–­é€»è¾‘ï¼Œæ ¹æ®æ˜¯å¦ä»¥ "www." å¼€å¤´ç”Ÿæˆä¸åŒçš„ SNI åˆ—è¡¨
                </div>
            `;
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡Œæµ‹è¯•
        document.addEventListener('DOMContentLoaded', runTests);
    </script>
</body>
</html>